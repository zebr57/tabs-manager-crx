const b=/\/\/(www\.)?([^.]+)/;let d=[],p={},u=[],a=[],f=[];const m=async()=>{d=await chrome.tabs.query({currentWindow:!0}),d.forEach(o=>{if(o.url){const e=l(o.url);e&&u.push(e)}}),u=Array.from(new Set(u)),p=w(d),a=y(p),console.log("域名与标签页的 map",p),console.log("存在同域名可生成分组：",a)};m();let i=null;chrome.tabs.onActivated.addListener(function(o){const e=o.tabId;chrome.tabs.get(e,function(t){console.log("当前选项卡信息:",t),i=t})});chrome.tabs.onCreated.addListener(function(o){console.log(o)});chrome.runtime.onMessage.addListener(async o=>{console.log(o,i);const{action:e,tab:t,isLast:r}=o;if(t){f.push(t);const n=f.map(({id:c})=>c);chrome.tabs.group({tabIds:n},function(){console.log("create group success!!"),r&&(f=[],chrome.tabs.update(t.id,{active:!0}))})}else e=="autoGroup"&&await I();if(!i)return;const s=i.groupId;if(s!=-1){const c=(await chrome.tabs.query({groupId:s})).map(g=>g.id);switch(e){case"cancelGroup":await chrome.tabs.ungroup(c);break;case"closeGroup":await chrome.tabs.remove(c);break}}else console.log("当前页面没有分组")});chrome.tabs.onUpdated.addListener(function(o,e,t){e.url&&(console.log("地址栏URL变化：",o,e.url,t),chrome.storage.sync.get(["isAuto"],async function(r){r.isAuto&&chrome.tabs.get(o,function(s){G(s)})}))});chrome.bookmarks.getTree(function(o){console.log(o)});const l=o=>{if(!o)return"";const e=o.match(b);return e&&e.length>2?e[2]:(console.log("无法匹配域名"),"")},w=o=>{let e={};for(const t of o)if(t.url){const r=l(t.url);r&&u.includes(r)&&(e[r]?e[r].push(t):e[r]=[t])}return e},y=o=>{let e=[];for(const t of Object.entries(o)){const r=t[0],s=t[1];s.length>1&&e.push({url:r,groupId:-2,children:s})}return e},I=async()=>{if(await m(),a&&a.length>0)for(const o of a){const e=o.children.map(({id:s})=>s),t=await chrome.tabs.group({tabIds:e});o.groupId=t;const r=o.url;await chrome.tabGroups.update(t,{title:r})}else console.log("当前不存在相同域名的标签页")},G=async o=>{if(await m(),console.log("groupTree",a),o.url){const e=l(o.url);if(console.log("新打开标签域名：",e),!e)return;const t=a.find(r=>r.url==e);if(console.log(t,"group"),t&&t.children.length>=3)chrome.tabGroups.query({},r=>{const s=r.find(n=>n.title==e);chrome.tabs.group({tabIds:o.id,groupId:s==null?void 0:s.id})});else{const r=await chrome.tabs.query({currentWindow:!0,groupId:-1});console.log("未分组选项卡：",r);const s=r.filter(n=>{var c;return((c=n.url)==null?void 0:c.indexOf(e))!=-1});if(s){const n=s.map(h=>h.id);if(n.length<=1)return;const c=await chrome.tabs.group({tabIds:n}),g=l(o.url);await chrome.tabGroups.update(c,{title:g})}}}else console.warn("新打开选项卡url：",o.url)};
