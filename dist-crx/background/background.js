"use strict";const b=/\/\/(www\.)?([^/]+)/;let d=[],u={},i=[],a=[],p=[];const h=async()=>{u={},i=[],d=await chrome.tabs.query({currentWindow:!0}),d.forEach(o=>{if(o.url){const t=l(o.url);t&&i.push(t)}}),i=Array.from(new Set(i));for(const o of d)if(o.url){const t=l(o.url);t&&i.includes(t)&&(u[t]?u[t].push(o):u[t]=[o])}a=[];for(const o of Object.entries(u)){const t=o[0],e=o[1];e.length>1&&a.push({url:t,groupId:-2,children:e})}console.log("当前窗口所有标签页：",d),console.log("存在同域名可生成分组：",a)};h();const w=async()=>{if(await h(),a&&a.length>0)for(const o of a){const t=o.children.map(({id:r})=>r),e=await chrome.tabs.group({tabIds:t});o.groupId=e;const s=l(o.url);await chrome.tabGroups.update(e,{title:s})}else console.log("当前不存在相同域名的标签页")};let g=null;chrome.tabs.onActivated.addListener(function(o){const t=o.tabId;chrome.tabs.get(t,function(e){console.log("当前选项卡信息:",e),g=e})});chrome.tabs.onCreated.addListener(function(o){console.log(o)});chrome.runtime.onMessage.addListener(async o=>{console.log(o,g);const{action:t,tab:e,isLast:s}=o;if(e){p.push(e);const n=p.map(({id:c})=>c);chrome.tabs.group({tabIds:n},function(){console.log("create group success!!"),s&&(p=[],chrome.tabs.update(e.id,{active:!0}))})}else t=="autoGroup"&&await w();if(!g)return;const r=g.groupId;if(r!=-1){const c=(await chrome.tabs.query({groupId:r})).map(f=>f.id);switch(t){case"cancelGroup":await chrome.tabs.ungroup(c);break;case"closeGroup":await chrome.tabs.remove(c);break}}else console.log("当前页面没有分组")});chrome.tabs.onUpdated.addListener(function(o,t,e){t.url&&(console.log("地址栏URL变化：",o,t.url,e),chrome.storage.sync.get(["isAuto"],async function(s){s.isAuto&&chrome.tabs.get(o,function(r){I(r)})}))});const l=o=>{if(!o)return"";const t=o.match(b);return t&&t.length>2?t[2]:(console.log("无法匹配域名"),"")},I=async o=>{if(await h(),console.log("groupTree",a),o.url){const t=l(o.url);if(console.log("新打开标签域名：",t),!t)return;const e=a.find(s=>s.url==t);if(console.log(e,"group"),e&&e.children.length>=3)chrome.tabGroups.query({},s=>{const r=s.find(n=>n.title==t);chrome.tabs.group({tabIds:o.id,groupId:r==null?void 0:r.id})});else{const s=await chrome.tabs.query({currentWindow:!0,groupId:-1});console.log("未分组选项卡：",s);const r=s.filter(n=>{var c;return((c=n.url)==null?void 0:c.indexOf(t))!=-1});if(r){const n=r.map(m=>m.id);if(n.length<=1)return;const c=await chrome.tabs.group({tabIds:n}),f=l(o.url);await chrome.tabGroups.update(c,{title:f})}}}else console.warn("新打开选项卡url：",o.url)};
